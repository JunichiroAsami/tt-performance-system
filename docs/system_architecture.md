# システム概要設計書：AI主導型 卓球パフォーマンス最大化システム

**バージョン**: 1.0  
**作成日**: 2026年1月3日  
**作成者**: Manus AI

---

## 1. 設計概要

### 1.1. 本ドキュメントの目的

本ドキュメントは、「業務要件書：AI主導型 卓球パフォーマンス最大化システム」に基づき、システム全体のアーキテクチャ、モジュール構成、データフロー、技術選定を定義する概要設計書である。

### 1.2. システム全体像

本システムは、卓球の試合・練習動画を入力とし、AIによる多角的な分析を経て、「深い分析レポート」「試合戦略シート」「練習計画書」を自動生成するエンドツーエンドのパイプラインである。

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         システム全体アーキテクチャ                        │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│   ┌──────────┐    ┌──────────────────────────────────────────────┐     │
│   │          │    │              分析エンジン層                    │     │
│   │  入力層   │    │  ┌────────────┐  ┌────────────┐  ┌────────┐ │     │
│   │          │───▶│  │ 定量分析   │  │ 定性分析   │  │ 統合   │ │     │
│   │ ・動画   │    │  │ (CV系)     │  │ (LLM系)    │  │ 分析   │ │     │
│   │ ・メタ   │    │  │            │  │            │  │        │ │     │
│   │  データ  │    │  │ OpenCV     │  │ Gemini     │  │        │ │     │
│   │          │    │  │ MediaPipe  │  │ API        │  │        │ │     │
│   └──────────┘    │  └─────┬──────┘  └─────┬──────┘  └────┬───┘ │     │
│                   │        │               │              │      │     │
│                   │        └───────────────┴──────────────┘      │     │
│                   └──────────────────────────────────────────────┘     │
│                                        │                               │
│                                        ▼                               │
│                   ┌──────────────────────────────────────────────┐     │
│                   │              出力生成層                       │     │
│                   │  ┌────────────┐  ┌────────────┐  ┌────────┐ │     │
│                   │  │ 分析       │  │ 戦略       │  │ 練習   │ │     │
│                   │  │ レポート   │  │ シート     │  │ 計画   │ │     │
│                   │  └────────────┘  └────────────┘  └────────┘ │     │
│                   └──────────────────────────────────────────────┘     │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 2. システムアーキテクチャ

### 2.1. レイヤー構成

本システムは以下の4層で構成される。

| レイヤー | 役割 | 主要コンポーネント |
|:---|:---|:---|
| **入力層** | 動画・メタデータの受け取りと前処理 | VideoLoader, Preprocessor |
| **分析エンジン層** | 定量分析・定性分析の実行 | CVAnalyzer, LLMAnalyzer, IntegrationEngine |
| **知識ベース層** | 分析結果・選手データの蓄積 | PlayerDB, MatchDB, AnalysisDB |
| **出力生成層** | レポート・戦略シートの自動生成 | ReportGenerator, StrategyGenerator, PracticeGenerator |

### 2.2. モジュール構成図

```
┌─────────────────────────────────────────────────────────────────────────┐
│                              入力層                                      │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │
│  │  VideoLoader    │  │  MetaDataParser │  │  Preprocessor   │         │
│  │  ・動画読込     │  │  ・試合情報     │  │  ・フレーム抽出 │         │
│  │  ・形式変換     │  │  ・選手情報     │  │  ・正規化       │         │
│  └────────┬────────┘  └────────┬────────┘  └────────┬────────┘         │
│           └────────────────────┴────────────────────┘                   │
│                                │                                        │
└────────────────────────────────┼────────────────────────────────────────┘
                                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           分析エンジン層                                 │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    CVAnalyzer (定量分析)                         │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │   │
│  │  │ BallTracker │  │ PoseEstimator│  │ CourtMapper │              │   │
│  │  │ ・軌道追跡  │  │ ・姿勢推定   │  │ ・コート検出│              │   │
│  │  │ ・速度算出  │  │ ・関節角度   │  │ ・位置マップ│              │   │
│  │  │ ・バウンス  │  │ ・動作分類   │  │             │              │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    LLMAnalyzer (定性分析)                        │   │
│  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐              │   │
│  │  │ TacticsAI   │  │ TechniqueAI │  │ MatchFlowAI │              │   │
│  │  │ ・戦術評価  │  │ ・技術評価  │  │ ・試合運び  │              │   │
│  │  │ ・判断分析  │  │ ・フォーム  │  │ ・メンタル  │              │   │
│  │  └─────────────┘  └─────────────┘  └─────────────┘              │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
│  ┌─────────────────────────────────────────────────────────────────┐   │
│  │                    IntegrationEngine (統合分析)                  │   │
│  │  ・定量データと定性評価の統合                                    │   │
│  │  ・得点/失点パターンの分類                                       │   │
│  │  ・強み/弱みの特定                                               │   │
│  └─────────────────────────────────────────────────────────────────┘   │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           知識ベース層                                   │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │
│  │    PlayerDB     │  │    MatchDB      │  │   AnalysisDB    │         │
│  │  ・選手プロフ   │  │  ・試合履歴     │  │  ・分析結果     │         │
│  │  ・成長履歴     │  │  ・対戦相手     │  │  ・トレンド     │         │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘         │
└─────────────────────────────────────────────────────────────────────────┘
                                 │
                                 ▼
┌─────────────────────────────────────────────────────────────────────────┐
│                           出力生成層                                     │
│  ┌─────────────────┐  ┌─────────────────┐  ┌─────────────────┐         │
│  │ ReportGenerator │  │StrategyGenerator│  │PracticeGenerator│         │
│  │ ・自己分析      │  │ ・戦略シート    │  │ ・練習計画      │         │
│  │ ・相手分析      │  │ ・サーブ戦略    │  │ ・ドリル提案    │         │
│  │ ・試合サマリー  │  │ ・展開戦略      │  │ ・優先課題      │         │
│  └─────────────────┘  └─────────────────┘  └─────────────────┘         │
└─────────────────────────────────────────────────────────────────────────┘
```

---

## 3. モジュール詳細設計

### 3.1. 入力層

#### 3.1.1. VideoLoader

| 項目 | 内容 |
|:---|:---|
| **機能** | 動画ファイルの読み込みと形式変換 |
| **入力** | MP4, MOV, AVI等の動画ファイル |
| **出力** | 標準化されたフレームシーケンス |
| **技術** | OpenCV (cv2.VideoCapture) |
| **処理内容** | ・動画の読み込み<br>・フレームレートの正規化（30fps）<br>・解像度の正規化（1280x720） |

#### 3.1.2. MetaDataParser

| 項目 | 内容 |
|:---|:---|
| **機能** | 試合・選手のメタデータ解析 |
| **入力** | JSON/YAML形式のメタデータファイル、またはユーザー入力 |
| **出力** | 構造化されたメタデータオブジェクト |
| **データ項目** | ・試合日時<br>・大会名<br>・対戦相手名・所属<br>・最終スコア |

#### 3.1.3. Preprocessor

| 項目 | 内容 |
|:---|:---|
| **機能** | 分析用のフレーム前処理 |
| **入力** | 正規化されたフレームシーケンス |
| **出力** | 分析用に最適化されたフレーム |
| **処理内容** | ・ノイズ除去<br>・コントラスト調整<br>・卓球台領域の検出・クロップ |

### 3.2. 分析エンジン層

#### 3.2.1. CVAnalyzer（定量分析モジュール）

##### BallTracker

| 項目 | 内容 |
|:---|:---|
| **機能** | ボールの軌道追跡と物理量算出 |
| **技術** | OpenCV (背景差分, Hough変換), カルマンフィルタ |
| **出力データ** | ・フレームごとのボール座標 (x, y)<br>・推定速度 (km/h)<br>・バウンス位置<br>・打球コース分類 |
| **対応要件** | FA-01, FA-03 |

##### PoseEstimator

| 項目 | 内容 |
|:---|:---|
| **機能** | 選手の姿勢推定と動作分析 |
| **技術** | MediaPipe Pose (33キーポイント) |
| **出力データ** | ・関節座標 (33点 x, y, z)<br>・関節角度（肘、膝、肩など）<br>・動作分類（フォア/バック/サーブ等）<br>・フットワーク移動量 |
| **対応要件** | FA-04, FA-05 |

##### CourtMapper

| 項目 | 内容 |
|:---|:---|
| **機能** | 卓球台の検出とコート座標系への変換 |
| **技術** | OpenCV (エッジ検出, 透視変換) |
| **出力データ** | ・卓球台の4隅座標<br>・選手位置のコート座標<br>・ボール落下位置のコート座標 |
| **対応要件** | FA-01, FA-05 |

#### 3.2.2. LLMAnalyzer（定性分析モジュール）

##### TacticsAI

| 項目 | 内容 |
|:---|:---|
| **機能** | 戦術・判断の評価 |
| **技術** | Gemini API (gemini-2.5-flash) |
| **入力** | 動画（直接アップロード）、CVAnalyzerの定量データ |
| **出力データ** | ・戦術パターンの分類<br>・判断の適切性評価<br>・改善提案 |
| **プロンプト設計** | 卓球コーチの視点で戦術を分析するよう指示 |
| **対応要件** | FA-01, FA-06, FS-04 |

##### TechniqueAI

| 項目 | 内容 |
|:---|:---|
| **機能** | 技術・フォームの評価 |
| **技術** | Gemini API (gemini-2.5-flash) |
| **入力** | 動画、PoseEstimatorの姿勢データ |
| **出力データ** | ・技術ごとの評価（5段階）<br>・フォームの問題点<br>・改善のためのドリル提案 |
| **プロンプト設計** | 理想的なフォームとの比較観点を明示 |
| **対応要件** | FA-02, FA-04, FP-03 |

##### MatchFlowAI

| 項目 | 内容 |
|:---|:---|
| **機能** | 試合運び・メンタル面の評価 |
| **技術** | Gemini API (gemini-2.5-flash) |
| **入力** | 動画、スコア推移データ |
| **出力データ** | ・試合の流れ分析<br>・競った場面での傾向<br>・メンタル面の評価 |
| **対応要件** | FR-01 |

#### 3.2.3. IntegrationEngine（統合分析モジュール）

| 項目 | 内容 |
|:---|:---|
| **機能** | 定量・定性分析結果の統合と最終評価 |
| **入力** | CVAnalyzer出力、LLMAnalyzer出力 |
| **処理内容** | ・得点/失点シーンの分類と集計<br>・技術別成功率の算出<br>・強み/弱みの特定と優先順位付け<br>・相手分析との比較 |
| **出力** | 統合分析結果オブジェクト |
| **対応要件** | 全分析要件 |

### 3.3. 知識ベース層

#### 3.3.1. データベース設計

```
┌─────────────────────────────────────────────────────────────────────────┐
│                          データベース構成                                │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  ┌─────────────────┐       ┌─────────────────┐                         │
│  │    players      │       │    matches      │                         │
│  ├─────────────────┤       ├─────────────────┤                         │
│  │ player_id (PK)  │◀──┐   │ match_id (PK)   │                         │
│  │ name            │   │   │ player_id (FK)  │──┐                      │
│  │ school          │   │   │ opponent_id (FK)│  │                      │
│  │ play_style      │   │   │ date            │  │                      │
│  │ dominant_hand   │   │   │ tournament      │  │                      │
│  │ created_at      │   │   │ score           │  │                      │
│  └─────────────────┘   │   │ result          │  │                      │
│                        │   │ video_path      │  │                      │
│  ┌─────────────────┐   │   └─────────────────┘  │                      │
│  │   opponents     │   │           │            │                      │
│  ├─────────────────┤   │           │            │                      │
│  │ opponent_id(PK) │◀──┼───────────┘            │                      │
│  │ name            │   │                        │                      │
│  │ school          │   │   ┌─────────────────┐  │                      │
│  │ play_style      │   │   │   analyses      │  │                      │
│  │ notes           │   │   ├─────────────────┤  │                      │
│  └─────────────────┘   │   │ analysis_id(PK) │  │                      │
│                        │   │ match_id (FK)   │──┘                      │
│                        │   │ player_id (FK)  │──┘                      │
│                        └───│ analysis_type   │                         │
│                            │ result_json     │                         │
│                            │ created_at      │                         │
│                            └─────────────────┘                         │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

#### 3.3.2. 主要テーブル定義

| テーブル名 | 用途 | 主要カラム |
|:---|:---|:---|
| **players** | 選手マスタ | player_id, name, school, play_style, dominant_hand |
| **opponents** | 対戦相手マスタ | opponent_id, name, school, play_style, notes |
| **matches** | 試合履歴 | match_id, player_id, opponent_id, date, score, result, video_path |
| **analyses** | 分析結果 | analysis_id, match_id, analysis_type, result_json |
| **practice_plans** | 練習計画 | plan_id, player_id, created_at, plan_json |

### 3.4. 出力生成層

#### 3.4.1. ReportGenerator

| 項目 | 内容 |
|:---|:---|
| **機能** | 各種分析レポートの自動生成 |
| **入力** | IntegrationEngineの統合分析結果 |
| **出力形式** | Markdown, PDF |
| **生成レポート種類** | ・自己分析レポート<br>・相手分析レポート<br>・試合後サマリーレポート |
| **対応要件** | FR-01 |

#### 3.4.2. StrategyGenerator

| 項目 | 内容 |
|:---|:---|
| **機能** | 試合戦略シートの自動生成 |
| **入力** | 自己分析結果、相手分析結果 |
| **出力形式** | Markdown (A4一枚), PDF |
| **生成内容** | ・サーブ戦略（種類×コース×場面）<br>・レシーブ戦略（相手サーブ別対応）<br>・ラリー展開戦略（攻撃の狙い目）<br>・注意点（相手の得意パターン） |
| **対応要件** | FS-01, FS-02, FS-03, FS-04 |

#### 3.4.3. PracticeGenerator

| 項目 | 内容 |
|:---|:---|
| **機能** | 練習計画の自動生成 |
| **入力** | 統合分析結果（特に弱み・課題） |
| **出力形式** | Markdown, PDF |
| **生成内容** | ・優先課題リスト（重要度順）<br>・課題別練習メニュー<br>・フォーム改善ドリル<br>・週間練習スケジュール案 |
| **対応要件** | FP-01, FP-02, FP-03 |

---

## 4. データフロー

### 4.1. 標準分析フロー

```
┌─────────────────────────────────────────────────────────────────────────┐
│                         標準分析フロー                                   │
├─────────────────────────────────────────────────────────────────────────┤
│                                                                         │
│  [1. 入力]                                                              │
│     │                                                                   │
│     ▼                                                                   │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │ 動画ファイル (.mp4) + メタデータ (試合情報)                       │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│     │                                                                   │
│     ▼                                                                   │
│  [2. 前処理]                                                            │
│     │                                                                   │
│     ▼                                                                   │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │ フレーム抽出 → 正規化 → 卓球台検出                               │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│     │                                                                   │
│     ├──────────────────────┬──────────────────────┐                    │
│     ▼                      ▼                      ▼                    │
│  [3a. 定量分析]         [3b. 定性分析]         [3c. 動画直接分析]      │
│     │                      │                      │                    │
│     ▼                      ▼                      ▼                    │
│  ┌────────────┐       ┌────────────┐       ┌────────────┐             │
│  │ OpenCV     │       │ Gemini API │       │ Gemini API │             │
│  │ MediaPipe  │       │ (テキスト) │       │ (動画)     │             │
│  │            │       │            │       │            │             │
│  │ ・ボール   │       │ ・戦術評価 │       │ ・全体評価 │             │
│  │   軌道     │       │ ・技術評価 │       │ ・詳細観察 │             │
│  │ ・姿勢推定 │       │            │       │            │             │
│  │ ・位置追跡 │       │            │       │            │             │
│  └─────┬──────┘       └─────┬──────┘       └─────┬──────┘             │
│        │                    │                    │                    │
│        └────────────────────┴────────────────────┘                    │
│                             │                                          │
│                             ▼                                          │
│  [4. 統合分析]                                                          │
│     │                                                                   │
│     ▼                                                                   │
│  ┌──────────────────────────────────────────────────────────────────┐  │
│  │ 定量データ + 定性評価 → 得点/失点パターン → 強み/弱み特定        │  │
│  └──────────────────────────────────────────────────────────────────┘  │
│     │                                                                   │
│     ├──────────────────────┬──────────────────────┐                    │
│     ▼                      ▼                      ▼                    │
│  [5a. レポート生成]     [5b. 戦略生成]         [5c. 練習計画生成]      │
│     │                      │                      │                    │
│     ▼                      ▼                      ▼                    │
│  ┌────────────┐       ┌────────────┐       ┌────────────┐             │
│  │ 分析       │       │ 戦略       │       │ 練習       │             │
│  │ レポート   │       │ シート     │       │ 計画書     │             │
│  │ (.md/.pdf) │       │ (.md/.pdf) │       │ (.md/.pdf) │             │
│  └────────────┘       └────────────┘       └────────────┘             │
│                                                                         │
└─────────────────────────────────────────────────────────────────────────┘
```

### 4.2. 処理時間見積もり

| 処理ステップ | 10分動画の場合 | 備考 |
|:---|:---|:---|
| 動画読込・前処理 | 約2分 | フレーム抽出、正規化 |
| 定量分析（CV系） | 約10分 | ボール追跡、姿勢推定 |
| 定性分析（LLM系） | 約5分 | Gemini API呼び出し |
| 統合分析 | 約2分 | データ統合、パターン分類 |
| レポート生成 | 約3分 | Markdown/PDF生成 |
| **合計** | **約22分** | 要件NF-01（30分以内）を満たす |

---

## 5. 技術選定

### 5.1. 技術スタック一覧

| カテゴリ | 技術 | バージョン | 選定理由 |
|:---|:---|:---|:---|
| **言語** | Python | 3.11+ | AI/ML系ライブラリの充実、開発効率 |
| **動画処理** | OpenCV | 4.8+ | 業界標準、豊富な機能 |
| **姿勢推定** | MediaPipe | 0.10+ | 軽量、高精度、リアルタイム対応 |
| **LLM** | Gemini API | gemini-2.5-flash | 動画直接入力対応、コスト効率 |
| **データベース** | SQLite | 3.x | 軽量、セットアップ不要、単一ファイル |
| **レポート生成** | Markdown + WeasyPrint | - | 柔軟なフォーマット、PDF変換対応 |

### 5.2. 外部API

| API | 用途 | 料金目安 |
|:---|:---|:---|
| **Gemini API** | 動画の定性分析、戦略・練習提案生成 | 約$0.01〜0.02/分（動画） |

### 5.3. ディレクトリ構成

```
tt_performance_system/
├── src/
│   ├── input/
│   │   ├── video_loader.py
│   │   ├── metadata_parser.py
│   │   └── preprocessor.py
│   ├── analysis/
│   │   ├── cv_analyzer/
│   │   │   ├── ball_tracker.py
│   │   │   ├── pose_estimator.py
│   │   │   └── court_mapper.py
│   │   ├── llm_analyzer/
│   │   │   ├── tactics_ai.py
│   │   │   ├── technique_ai.py
│   │   │   └── match_flow_ai.py
│   │   └── integration_engine.py
│   ├── database/
│   │   ├── models.py
│   │   └── repository.py
│   ├── output/
│   │   ├── report_generator.py
│   │   ├── strategy_generator.py
│   │   └── practice_generator.py
│   └── main.py
├── data/
│   ├── videos/
│   ├── outputs/
│   └── database.sqlite
├── config/
│   └── settings.yaml
├── tests/
├── requirements.txt
└── README.md
```

---

## 6. インターフェース設計

### 6.1. CLI インターフェース（初期版）

```bash
# 基本的な分析実行
$ python main.py analyze --video match_20260103.mp4 --player asami

# 相手分析を含む戦略シート生成
$ python main.py strategy --video match_20260103.mp4 --opponent tanaka

# 練習計画生成
$ python main.py practice --player asami --focus backhand
```

### 6.2. 入出力フォーマット

#### 入力：メタデータ (YAML)

```yaml
match:
  date: "2026-01-03"
  tournament: "東京都高校卓球選手権"
  player: "浅見江里佳"
  opponent: "田中花子"
  opponent_school: "○○高校"
  score: "3-1"
  result: "win"
```

#### 出力：分析結果 (JSON)

```json
{
  "analysis_id": "20260103_001",
  "player": "浅見江里佳",
  "summary": {
    "strengths": ["フォアハンドドライブの威力", "3球目攻撃の成功率"],
    "weaknesses": ["バックハンドの安定性", "ミドル処理"],
    "win_rate_by_technique": {
      "forehand_drive": 0.72,
      "backhand_drive": 0.48,
      "serve": 0.65
    }
  },
  "recommendations": {
    "practice": ["バックハンドの多球練習", "ミドル処理の反復"],
    "strategy": ["相手のバック側を攻める", "サーブは短く出す"]
  }
}
```

---

## 7. 今後の拡張計画

| フェーズ | 内容 | 優先度 |
|:---|:---|:---|
| **Phase 1（MVP）** | CLI版、基本分析機能、レポート生成 | 高 |
| **Phase 2** | Web UI、ダッシュボード、履歴管理 | 中 |
| **Phase 3** | 動画アノテーション、ハイライト自動生成 | 中 |
| **Phase 4** | 複数選手対応、チーム分析機能 | 低 |

---

## 8. リスクと対策

| リスク | 影響 | 対策 |
|:---|:---|:---|
| **ボール追跡精度の低下** | 定量分析の信頼性低下 | 複数アルゴリズムの併用、手動補正機能 |
| **LLM出力の不安定性** | 分析結果のばらつき | プロンプトの厳密化、出力検証ロジック |
| **動画品質のばらつき** | 分析精度の低下 | 前処理の強化、品質チェック機能 |
| **API利用コストの増大** | 運用コスト増 | キャッシュ活用、バッチ処理 |

---

## 9. 用語集

| 用語 | 定義 |
|:---|:---|
| **3球目攻撃** | サーブを出した後、相手のレシーブを攻撃する戦術 |
| **ミドル** | 選手の体の正面付近、フォアとバックの切り替えが難しいコース |
| **多球練習** | 練習相手が連続してボールを出し、特定の技術を反復練習する方法 |
| **システム練習** | 決められたパターンでラリーを行う練習方法 |


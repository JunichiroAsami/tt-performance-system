# TDD再構築 完了レポート

**作成日**: 2026-01-05  
**ブランチ**: `tdd-rebuild`

---

## 概要

「テスト成功報告と実動作の乖離」問題を受け、TDD（テスト駆動開発）アプローチでシステムを最初から再構築しました。

---

## 開発プロセス

### 従来のアプローチ（問題あり）

```
機能を作る → テストを書く → テストが通る → 「完成」と報告
                              ↓
                    実際には動かなかった
```

### 今回のアプローチ（TDD）

```
Step 1: 技術検証（動画をAPIに送れるか確認）
    ↓ 動作確認 ✅
Step 2: 分析機能を実装 → 実動画で動作確認 → テストを書く
    ↓ 動作確認 ✅ → テスト成功 ✅
Step 3: 戦略生成機能を実装 → 実データで動作確認 → テストを書く
    ↓ 動作確認 ✅ → テスト成功 ✅
Step 4: 練習計画機能を実装 → 実データで動作確認 → テストを書く
    ↓ 動作確認 ✅ → テスト成功 ✅
Step 5: E2Eテストを作成 → 全フローで動作確認
    ↓ 動作確認 ✅ → テスト成功 ✅
```

**原則: 「動くことを確認してからテストを書く」「テストは実データを使う」**

---

## 成果物

### 実装ファイル

| ファイル | 機能 | 動作確認 |
|:---|:---|:---:|
| `src/analyzer.py` | 動画分析（フレーム抽出→Gemini API） | ✅ 実動画で確認 |
| `src/strategy.py` | 戦略シート生成 | ✅ 実データで確認 |
| `src/practice.py` | 練習計画生成 | ✅ 実データで確認 |

### テストファイル

| ファイル | テスト数 | 結果 |
|:---|:---:|:---:|
| `tests/test_analyzer.py` | 13 | ✅ 全成功 |
| `tests/test_strategy.py` | 13 | ✅ 全成功 |
| `tests/test_practice.py` | 14 | ✅ 全成功 |
| `tests/test_e2e.py` | 13 | ✅ 全成功 |
| **合計** | **53** | **✅ 全成功** |

### エビデンス

| ファイル | 内容 |
|:---|:---|
| `tests/evidence/analyzer_test_evidence.json` | 分析結果の入出力 |
| `tests/evidence/strategy_test_evidence.json` | 戦略シートの入出力 |
| `tests/evidence/practice_test_evidence.json` | 練習計画の入出力 |
| `tests/evidence/e2e_test_evidence.json` | 全パイプラインの入出力 |

---

## テスト内容

### 分析機能テスト（13件）

**動作確認テスト**:
- 動画ファイルが存在すること
- Analyzerがインスタンス化できること
- 分析結果が辞書型で返ること
- パースエラーがないこと

**品質テスト**:
- 基本情報（利き手、グリップ、プレースタイル）が含まれていること
- 基本情報の値が妥当であること（利き手は「右」または「左」など）
- 技術評価（5項目）が含まれていること
- 技術スコアが1-5の範囲であること
- 戦術分析（得点/失点パターン）が含まれていること
- 得点パターンに卓球用語が含まれていること
- 改善提案が含まれていること
- 改善提案が具体的であること

### 戦略生成テスト（13件）

**動作確認テスト**:
- Generatorがインスタンス化できること
- 生成結果が辞書型で返ること
- パースエラーがないこと

**品質テスト**:
- サーブ戦略（序盤/中盤/終盤）が含まれていること
- サーブ戦略に推奨サーブと狙いが含まれていること
- レシーブ戦略が含まれていること
- ラリー戦略（基本方針、得点パターン）が含まれていること
- メンタル戦略が含まれていること
- ワンポイントアドバイスが含まれていること
- 卓球用語が5個以上含まれていること
- A4一枚程度の分量であること（500-5000文字）

### 練習計画テスト（14件）

**動作確認テスト**:
- Plannerがインスタンス化できること
- 生成結果が辞書型で返ること
- パースエラーがないこと

**品質テスト**:
- 優先課題が含まれていること
- 優先課題に詳細（課題、理由、優先度）が含まれていること
- 週間計画が5日分以上あること
- 各日の計画にテーマがあること
- 各日の計画にメニューがあること
- ドリル集が3つ以上あること
- ドリルに詳細（名前、手順、ポイント）が含まれていること
- ドリルの手順が2ステップ以上あること
- 達成目標が含まれていること
- 卓球用語が5個以上含まれていること

### E2Eテスト（13件）

**動作確認テスト**:
- テスト用動画が存在すること
- 全パイプラインがエラーなく完了すること
- 全出力にパースエラーがないこと

**品質テスト**:
- 分析結果に必須セクションがあること
- 戦略シートに必須セクションがあること
- 練習計画に必須セクションがあること
- 戦略が分析結果に基づいていること
- 練習計画が改善点に対応していること
- 全出力に卓球用語が含まれていること

**実用性テスト**:
- 戦略シートが読める長さであること
- 練習計画が5日分以上あること
- ドリルが実行可能な内容であること

---

## 実行結果

### 入力

- **動画ファイル**: `data/asami_match.mp4`
- **サイズ**: 55.6 MB
- **長さ**: 221秒（約3分41秒）
- **解像度**: 1280x720

### 出力サンプル

**分析結果**:
```json
{
  "基本情報": {
    "利き手": "右",
    "グリップ": "シェークハンド",
    "プレースタイル": "ドライブ主戦型"
  },
  "技術評価": {
    "フォアハンド": {"スコア": 3, "コメント": "..."},
    "バックハンド": {"スコア": 3, "コメント": "..."},
    "サーブ": {"スコア": 3, "コメント": "..."},
    "レシーブ": {"スコア": 3, "コメント": "..."},
    "フットワーク": {"スコア": 4, "コメント": "構えでのスタンスは広く、低い姿勢が保たれている..."}
  },
  ...
}
```

**戦略シート**:
```json
{
  "サーブ戦略": {
    "序盤": {"推奨サーブ": "フォア前への短く低いサーブ", "狙い": "相手のレシーブ技術を探る"},
    ...
  },
  "レシーブ戦略": {...},
  "ラリー戦略": {
    "基本方針": "フットワークの機敏性を活かし、常に低い姿勢で左右に揺さぶりをかける",
    ...
  },
  ...
}
```

**練習計画**:
```json
{
  "優先課題": [
    {"課題": "基本打法の安定性確認と向上", "理由": "...", "優先度": 1},
    ...
  ],
  "週間計画": {
    "1日目": {"テーマ": "基本技術の確認とフットワークの連携", "メニュー": [...]},
    ...
  },
  "ドリル集": [...],
  "達成目標": {...}
}
```

---

## 従来との違い

| 項目 | 従来 | 今回 |
|:---|:---|:---|
| テストデータ | モック（模擬）データ | **実動画** |
| 動作確認 | テスト実行のみ | **実際に動画を分析して確認** |
| テスト内容 | 形式確認（キーがあるか） | **品質確認（内容が妥当か）** |
| エビデンス | テスト結果のみ | **入力・出力・検証結果を全て保存** |
| 開発順序 | 実装→テスト | **技術検証→実装→動作確認→テスト** |

---

## 結論

**「テストが通った」と「システムが動く」が一致するようになりました。**

全53件のテストは、実際の動画を使用して実行され、システムが正しく動作することを確認しています。

---

## 次のステップ

1. **UAT（ユーザー受入テスト）**: 浅見選手またはコーチによる評価
2. **masterブランチへのマージ**: PRを作成してレビュー後にマージ
3. **CI/CDパイプラインの設定**: GitHub Actionsワークフローの手動追加
